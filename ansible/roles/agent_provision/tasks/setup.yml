---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  become: yes

- name: Check if reboot is required
  stat:
    path: /var/run/reboot-required
  register: reboot_required
  become: yes

- name: Reboot if required (kernel update)
  reboot:
    msg: "Rebooting for kernel update"
    reboot_timeout: 300
  become: yes
  when: reboot_required.stat.exists

- name: Install base packages
  apt:
    name: "{{ base_packages }}"
    state: present
  become: yes

- name: Install qemu-guest-agent for live VM snapshots
  apt:
    name: qemu-guest-agent
    state: present
  become: yes

- name: Enable and start qemu-guest-agent
  systemd:
    name: qemu-guest-agent
    enabled: yes
    state: started
  become: yes

# Dotfiles repository clone
- name: Clone dotfiles repository on controller
  ansible.builtin.git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_local_path }}"
    version: "{{ dotfiles_branch }}"
    force: yes
    accept_hostkey: yes
  delegate_to: localhost
  run_once: true
  when: deploy_dotfiles_from_repo

# Python installation
- name: Add deadsnakes PPA for Python
  apt_repository:
    repo: ppa:deadsnakes/ppa
    state: present
  become: yes
  when: install_python

- name: Install Python {{ python_version }}
  apt:
    name:
      - python{{ python_version }}
      - python{{ python_version }}-dev
      - python{{ python_version }}-venv
      - python3-pip
    state: present
  become: yes
  when: install_python

- name: Install uv (fast Python package manager)
  shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: ~/.cargo/bin/uv
  when: install_python

# Node.js installation
- name: Download Node.js {{ nodejs_version }} setup script
  get_url:
    url: https://deb.nodesource.com/setup_{{ nodejs_version }}.x
    dest: /tmp/node_setup.sh
    mode: '0755'
  when: install_nodejs

- name: Run Node.js setup script
  shell: /tmp/node_setup.sh
  become: yes
  when: install_nodejs
  args:
    creates: /etc/apt/sources.list.d/nodesource.list

- name: Install Node.js and npm
  apt:
    name:
      - nodejs
    state: present
    update_cache: yes
  become: yes
  when: install_nodejs

# Dart and Flutter installation
- name: Add Dart/Flutter apt key
  shell: |
    wget -qO- https://dl-ssl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/dart.gpg
  become: yes
  when: install_dart_flutter
  args:
    creates: /usr/share/keyrings/dart.gpg

- name: Add Flutter repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/dart.gpg arch=amd64] https://storage.googleapis.com/download.dartlang.org/linux/debian stable main"
    state: present
    filename: dart_stable
  become: yes
  when: install_dart_flutter

- name: Install Dart SDK
  apt:
    name: dart
    state: present
    update_cache: yes
  become: yes
  when: install_dart_flutter

- name: Download Flutter SDK
  git:
    repo: https://github.com/flutter/flutter.git
    dest: ~/.flutter
    version: "{{ flutter_channel }}"
    depth: 1
  when: install_dart_flutter

- name: Add Flutter to PATH
  lineinfile:
    path: ~/.bashrc
    line: 'export PATH="$PATH:$HOME/.flutter/bin"'
    create: yes
  when: install_dart_flutter

# Rust installation
- name: Install Rust via rustup
  shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    creates: ~/.cargo/bin/rustc
  when: install_rust

- name: Add Rust to PATH
  lineinfile:
    path: ~/.bashrc
    line: 'source $HOME/.cargo/env'
    create: yes
  when: install_rust

# Go installation
- name: Download Go {{ golang_version }}
  get_url:
    url: https://go.dev/dl/go{{ golang_version }}.linux-amd64.tar.gz
    dest: /tmp/go{{ golang_version }}.tar.gz
  when: install_golang

- name: Extract Go
  unarchive:
    src: /tmp/go{{ golang_version }}.tar.gz
    dest: ~/.local/
    remote_src: yes
    creates: ~/.local/go/bin/go
  when: install_golang

- name: Add Go to PATH
  lineinfile:
    path: ~/.bashrc
    line: 'export PATH="$PATH:$HOME/.local/go/bin"'
    create: yes
  when: install_golang

# C/C++ tools
- name: Install C/C++ development tools
  apt:
    name:
      - gcc
      - g++
      - clang
      - cmake
      - gdb
      - valgrind
    state: present
  become: yes
  when: install_cpp

- name: Install clangd for C/C++ LSP
  apt:
    name: clangd
    state: present
  become: yes
  when: install_cpp

- name: Install tree-sitter CLI via cargo
  shell: ~/.cargo/bin/cargo install tree-sitter-cli
  args:
    creates: ~/.cargo/bin/tree-sitter
  when: install_rust

# Docker installation
- name: Install Docker
  apt:
    name:
      - docker.io
      - docker-compose
    state: present
  become: yes
  when: install_docker

- name: Add user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes
  become: yes
  when: install_docker

# AWS CLI
- name: Download AWS CLI v2
  get_url:
    url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    dest: /tmp/awscliv2.zip
  when: install_aws_cli

- name: Extract AWS CLI
  unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp/
    remote_src: yes
  when: install_aws_cli

- name: Install AWS CLI
  shell: /tmp/aws/install
  become: yes
  when: install_aws_cli
  args:
    creates: /usr/local/bin/aws

# AWS CDK
- name: Install AWS CDK globally
  npm:
    name: aws-cdk
    global: yes
    state: present
  become: yes
  when: install_aws_cdk and install_nodejs

# GitHub CLI
- name: Download GitHub CLI repository key
  shell: |
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
  become: yes
  args:
    creates: /usr/share/keyrings/githubcli-archive-keyring.gpg

- name: Add GitHub CLI repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
    state: present
    filename: github-cli
  become: yes

- name: Install GitHub CLI
  apt:
    name: gh
    state: present
    update_cache: yes
  become: yes

# Python dev tools
- name: Install Python development tools
  shell: bash -lc "uv tool install {{ item }}"
  args:
    creates: ~/.local/bin/{{ item }}
  loop:
    - ruff
    - isort
  when: install_python

# Node.js dev tools
- name: Install Node.js development tools
  npm:
    name: "{{ item }}"
    global: yes
    state: present
  become: yes
  loop:
    - pyright
    - prettier
    - jsonlint
    - fixjson
    - yaml-language-server
    - vscode-langservers-extracted
    - dot-language-server
  when: install_dev_tools and install_nodejs

# Neovim configuration
- name: Create .config directory
  file:
    path: ~/.config
    state: directory
    mode: '0755'

- name: Remove existing neovim config for refresh
  file:
    path: ~/.config/nvim
    state: absent
  when: force_dotfiles_refresh

- name: Copy neovim configuration from dotfiles
  copy:
    src: "{{ dotfiles_local_path }}/.config/nvim/"
    dest: ~/.config/nvim/
    mode: '0644'
    directory_mode: '0755'
    force: no
  when: deploy_dotfiles_from_repo

- name: Copy neovim configuration (embedded fallback)
  copy:
    src: nvim/
    dest: ~/.config/nvim/
    mode: '0644'
    directory_mode: '0755'
    force: no
  when: not deploy_dotfiles_from_repo

# oh-my-posh prompt (replaces Starship)
- name: Create .local/bin directory
  file:
    path: ~/.local/bin
    state: directory
    mode: '0755'
  when: install_oh_my_posh

- name: Download oh-my-posh binary
  get_url:
    url: https://github.com/JanDeDobbeleer/oh-my-posh/releases/latest/download/posh-linux-amd64
    dest: ~/.local/bin/oh-my-posh
    mode: '0755'
  when: install_oh_my_posh

- name: Remove existing oh-my-posh theme for refresh
  file:
    path: ~/{{ oh_my_posh_theme }}
    state: absent
  when: force_dotfiles_refresh

- name: Copy oh-my-posh theme from dotfiles
  copy:
    src: "{{ dotfiles_local_path }}/{{ oh_my_posh_theme }}"
    dest: ~/{{ oh_my_posh_theme }}
    mode: '0644'
    force: no
  when: install_oh_my_posh and deploy_dotfiles_from_repo

- name: Copy oh-my-posh theme (embedded fallback)
  copy:
    src: oh-my-posh/{{ oh_my_posh_theme }}
    dest: ~/{{ oh_my_posh_theme }}
    mode: '0644'
    force: no
  when: install_oh_my_posh and not deploy_dotfiles_from_repo

# Nerd Fonts for oh-my-posh
- name: Create fonts directory
  file:
    path: ~/.local/share/fonts
    state: directory
    mode: '0755'
  when: install_nerd_fonts

- name: Download JetBrains Mono Nerd Font
  get_url:
    url: https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip
    dest: /tmp/JetBrainsMono.zip
  when: install_nerd_fonts

- name: Extract Nerd Font
  unarchive:
    src: /tmp/JetBrainsMono.zip
    dest: ~/.local/share/fonts/
    remote_src: yes
  when: install_nerd_fonts

- name: Update font cache
  shell: fc-cache -f -v
  when: install_nerd_fonts
  ignore_errors: yes

# vim-plug for neovim
- name: Create neovim autoload directory
  file:
    path: ~/.local/share/nvim/site/autoload
    state: directory
    mode: '0755'
  when: install_vim_plug

- name: Download vim-plug
  get_url:
    url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    dest: ~/.local/share/nvim/site/autoload/plug.vim
    mode: '0644'
  when: install_vim_plug

- name: Install neovim plugins
  shell: nvim --headless +PlugInstall +qall
  when: install_vim_plug
  ignore_errors: yes

# Bin scripts deployment
- name: Create bin directory
  file:
    path: ~/bin
    state: directory
    mode: '0755'
  when: deploy_bin_scripts

- name: Remove existing bin scripts for refresh
  file:
    path: ~/bin
    state: absent
  when: force_dotfiles_refresh

- name: Copy bin scripts from dotfiles
  copy:
    src: "{{ dotfiles_local_path }}/bin/"
    dest: ~/bin/
    mode: '0755'
    directory_mode: '0755'
    force: no
  when: deploy_bin_scripts and deploy_dotfiles_from_repo

- name: Copy bin scripts (embedded fallback)
  copy:
    src: "bin/{{ item }}"
    dest: "~/bin/{{ item }}"
    mode: '0755'
    force: no
  loop:
    - pswitch
    - kswitch
  when: deploy_bin_scripts and not deploy_dotfiles_from_repo

# Claude Code configuration
- name: Create .claude directory
  file:
    path: ~/.claude
    state: directory
    mode: '0755'
  when: deploy_claude_config and deploy_dotfiles_from_repo

- name: Remove existing Claude config for refresh
  file:
    path: ~/.claude
    state: absent
  when: force_dotfiles_refresh

- name: Copy Claude Code configuration from dotfiles
  copy:
    src: "{{ dotfiles_local_path }}/.claude/"
    dest: ~/.claude/
    mode: '0644'
    directory_mode: '0755'
    force: no
  when: deploy_claude_config and deploy_dotfiles_from_repo

# Shell configuration
- name: Check if bash_profile exists
  stat:
    path: ~/.bash_profile
  register: bash_profile_stat

- name: Check if bashrc exists
  stat:
    path: ~/.bashrc
  register: bashrc_stat

- name: Deploy bash_profile from template
  template:
    src: bash_profile.j2
    dest: ~/.bash_profile
    mode: '0644'
  when: shell_config_source == "template" and not bash_profile_stat.stat.exists

- name: Deploy bashrc from template
  template:
    src: bashrc.j2
    dest: ~/.bashrc
    mode: '0644'
  when: shell_config_source == "template" and not bashrc_stat.stat.exists

- name: Deploy bash_profile from dotfiles
  copy:
    src: "{{ dotfiles_local_path }}/.bash_profile"
    dest: ~/.bash_profile
    mode: '0644'
    force: no
  when: shell_config_source == "dotfiles" and deploy_dotfiles_from_repo

- name: Deploy bashrc from dotfiles
  copy:
    src: "{{ dotfiles_local_path }}/.bashrc"
    dest: ~/.bashrc
    mode: '0644'
    force: no
  when: shell_config_source == "dotfiles" and deploy_dotfiles_from_repo

# AI coding tools - Note: These require manual authentication
- name: Install Claude Code CLI
  shell: curl -fsSL https://raw.githubusercontent.com/anthropics/claude-code/main/install.sh | sh
  args:
    creates: ~/.local/bin/claude-code
  when: install_claude_code

- name: Create reminder for Claude Code authentication
  debug:
    msg: "REMINDER: Claude Code CLI installed but requires manual authentication via 'claude-code auth'"
  when: install_claude_code

- name: Install OpenAI Codex CLI placeholder
  debug:
    msg: "REMINDER: Codex CLI installation requires manual setup - visit https://platform.openai.com/docs/guides/code"
  when: install_codex_cli

- name: Install Google Gemini CLI placeholder
  debug:
    msg: "REMINDER: Gemini CLI installation requires manual setup - visit https://ai.google.dev/tutorials/setup"
  when: install_gemini_cli

# Cleanup dotfiles checkout
- name: Remove dotfiles checkout from controller
  file:
    path: "{{ dotfiles_local_path }}"
    state: absent
  delegate_to: localhost
  run_once: true
  when: deploy_dotfiles_from_repo

# Final setup
- name: Display completion message
  debug:
    msg:
      - "Agent environment provisioned successfully!"
      - "Installed components:"
      - "  - Python {{ python_version }}"
      - "  - Node.js {{ nodejs_version }}"
      - "  - Dart/Flutter"
      - "  - Rust"
      - "  - Go {{ golang_version }}"
      - "  - C/C++ tools"
      - "  - Docker"
      - "  - AWS CLI and CDK"
      - "  - GitHub CLI"
      - "  - Neovim (with custom config and plugins)"
      - "  - oh-my-posh prompt with JetBrains Mono Nerd Font"
      - "  - Shell utilities (pswitch, kswitch)"
      - ""
      - "NEXT STEPS:"
      - "  1. Authenticate Claude Code: claude-code auth"
      - "  2. Authenticate GitHub CLI: gh auth login"
      - "  3. Configure AWS credentials: aws configure"
      - "  4. Install Codex CLI manually"
      - "  5. Install Gemini CLI manually"
