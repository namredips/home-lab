---
# Create a single agent VM
- name: Set agent facts
  set_fact:
    agent_name: "{{ agent_item.key }}"
    agent_config: "{{ agent_item.value }}"

- name: Create disk image for {{ agent_name }}
  shell: |
    qemu-img create -f qcow2 -F qcow2 -b {{ vm_base_image_path }} \
      /var/lib/libvirt/images/{{ agent_name }}.qcow2 {{ agent_config.disk_gb }}G
  become: yes
  args:
    creates: /var/lib/libvirt/images/{{ agent_name }}.qcow2

- name: Resize disk for {{ agent_name }}
  shell: |
    qemu-img resize /var/lib/libvirt/images/{{ agent_name }}.qcow2 {{ agent_config.disk_gb }}G
  become: yes

- name: Create cloud-init config for {{ agent_name }}
  template:
    src: vm-cloudinit.yml.j2
    dest: /tmp/{{ agent_name }}-cloudinit.yml
    mode: '0644'

- name: Create network config for {{ agent_name }}
  template:
    src: vm-network-config.yml.j2
    dest: /tmp/{{ agent_name }}-network-config.yml
    mode: '0644'

- name: Remove old cloud-init ISO for {{ agent_name }} if exists
  file:
    path: /var/lib/libvirt/images/{{ agent_name }}-seed.img
    state: absent
  become: yes

- name: Create cloud-init ISO for {{ agent_name }}
  shell: |
    cloud-localds \
      --disk-format raw \
      --network-config=/tmp/{{ agent_name }}-network-config.yml \
      /var/lib/libvirt/images/{{ agent_name }}-seed.img \
      /tmp/{{ agent_name }}-cloudinit.yml
  become: yes

- name: Define VM for {{ agent_name }}
  shell: |
    virt-install \
      --name {{ agent_name }} \
      --memory {{ agent_config.memory_mb }} \
      --vcpus {{ agent_config.vcpus }} \
      --disk /var/lib/libvirt/images/{{ agent_name }}.qcow2,device=disk,bus=virtio \
      --disk /var/lib/libvirt/images/{{ agent_name }}-seed.img,device=cdrom \
      --os-variant ubuntu24.04 \
      --network network={{ vm_network }},model={{ vm_network_model }} \
      --graphics spice,listen=0.0.0.0 \
      --video qxl \
      --channel spicevmc,target_type=virtio,name=com.redhat.spice.0 \
      --channel unix,target_type=virtio,name=org.qemu.guest_agent.0 \
      --console pty,target_type=serial \
      --import \
      --noautoconsole
  become: yes
  register: vm_create
  failed_when: false

- name: Start VM {{ agent_name }} if not running
  shell: virsh start {{ agent_name }} 2>&1 || true
  become: yes
  register: vm_start
  changed_when: "'Domain is already active' not in vm_start.stdout and vm_start.rc == 0"
  failed_when: false

- name: Set VM {{ agent_name }} to autostart
  shell: virsh autostart {{ agent_name }} 2>&1 || true
  become: yes
  failed_when: false
