#cloud-config
hostname: {{ agent_name }}
fqdn: {{ agent_name }}.infiquetra.com
manage_etc_hosts: true

users:
  - name: {{ vm_ssh_user }}
    groups: sudo
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - {{ vm_ssh_authorized_keys }}

# Network configuration with static IP
network:
  version: 2
  ethernets:
    ens3:
      dhcp4: false
      addresses:
        - {{ agent_config.ip }}/24
      gateway4: 10.220.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4

# Package updates and installations
package_update: true
package_upgrade: true

packages:
  - qemu-guest-agent
  - openssh-server
  - curl
  - wget
  - git
  - vim
  - cloud-init
  - cloud-guest-utils

# Enable SSH
ssh_pwauth: false

# Grow root filesystem
growpart:
  mode: auto
  devices: ['/']

# Run commands on first boot
runcmd:
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - echo "{{ agent_name }} agent VM initialized" > /etc/motd

# Final message
final_message: "{{ agent_name }} cloud-init complete after $UPTIME seconds"
