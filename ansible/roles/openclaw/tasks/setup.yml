---
- name: Ensure Node.js is installed
  shell: node --version
  register: node_check
  changed_when: false
  failed_when: node_check.rc != 0

- name: Install OpenClaw globally via npm
  npm:
    name: openclaw
    global: yes
    version: "{{ openclaw_version }}"
    state: present
  become: yes

- name: Create OpenClaw config directory
  file:
    path: "{{ openclaw_install_dir }}"
    state: directory
    mode: '0755'

- name: Create OpenClaw configuration file
  template:
    src: openclaw.json.j2
    dest: "{{ openclaw_install_dir }}/openclaw.json"
    mode: '0600'
  notify: restart openclaw-gateway

- name: Create OpenClaw environment file
  template:
    src: openclaw.env.j2
    dest: "{{ openclaw_install_dir }}/.env"
    mode: '0600'

- name: Create OpenClaw workspace directory
  file:
    path: "{{ openclaw_install_dir }}/workspace"
    state: directory
    mode: '0755'

- name: Deploy agent personality files
  template:
    src: "{{ loop_item }}.j2"
    dest: "{{ openclaw_install_dir }}/workspace/{{ loop_item }}"
    mode: '0644'
  vars:
    item:
      key: "{{ inventory_hostname_short }}"
  loop:
    - SOUL.md
    - IDENTITY.md
    - AGENTS.md
    - BOOTSTRAP.md
    - USER.md
  loop_control:
    loop_var: loop_item

- name: Create systemd service for OpenClaw Gateway
  template:
    src: openclaw.service.j2
    dest: /etc/systemd/system/openclaw-gateway.service
    mode: '0644'
  become: yes
  when: openclaw_enable_service

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes
  when: openclaw_enable_service

- name: Enable and start OpenClaw Gateway service
  systemd:
    name: openclaw-gateway
    enabled: yes
    state: started
  become: yes
  when: openclaw_enable_service

- name: Display OpenClaw setup information
  debug:
    msg:
      - "OpenClaw installed for agent: {{ agent_name }}"
      - "Email: {{ agent_email }}"
      - "Config: {{ openclaw_install_dir }}/openclaw.json"
      - "LLM Provider: Ollama Cloud (http://127.0.0.1:11434/v1)"
      - "Primary Model: {{ ollama_primary_model }}"
      - ""
      - "Discord: Enabled (Guild ID: {{ discord_guild_id }})"
      - ""
      - "Service: sudo systemctl start openclaw-gateway"
      - "Web dashboard: http://{{ ansible_host }}:{{ openclaw_dashboard_port }}"
      - ""
      - "Verify models: ollama list"
