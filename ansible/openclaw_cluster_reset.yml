---
# OpenClaw Virtual Employee Infrastructure Teardown
# This playbook removes the entire "Mount Olympus" agent cluster

- name: Confirm reset operation
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display warning
      debug:
        msg:
          - "=========================================="
          - "WARNING: DESTRUCTIVE OPERATION"
          - "=========================================="
          - ""
          - "This will remove:"
          - "  - All 7 agent VMs"
          - "  - OpenClaw services and configs"
          - "  - Libvirt VMs and networks"
          - ""
          - "This will NOT remove:"
          - "  - Host OS updates and packages"
          - "  - Disk mounts and storage"
          - "  - VM disk images (unless manually deleted)"
          - ""
          - "Press Ctrl+C to abort, or continue to proceed"
          - "=========================================="

    - name: Wait for confirmation
      pause:
        seconds: 10

- name: Pre-flight safety check
  hosts: hypervisors
  gather_facts: no
  tasks:
    - name: Verify sudo access before proceeding
      command: sudo whoami
      changed_when: false

    - name: Verify sudoers.d backup exists
      stat:
        path: /etc/sudoers.d/jefcox-permanent
      register: sudo_backup

    - name: ABORT if no sudo safeguard
      fail:
        msg: "SAFETY: /etc/sudoers.d/jefcox-permanent missing. Run host_prepare first."
      when: not sudo_backup.stat.exists

- name: Stop OpenClaw agents
  hosts: agent_vms
  gather_facts: no
  roles:
    - { role: openclaw, reset: True, tags: ['openclaw'] }
  ignore_errors: yes

- name: Remove agent environments
  hosts: agent_vms
  gather_facts: no
  roles:
    - { role: agent_provision, reset: True, tags: ['agent_provision'] }
  ignore_errors: yes

- name: Remove agent VMs
  hosts: hypervisors
  gather_facts: yes
  roles:
    - { role: agent_vm, reset: True, tags: ['agent_vm'] }

- name: Remove libvirt networks and VMs
  hosts: hypervisors
  gather_facts: no
  roles:
    - { role: libvirt, reset: True, tags: ['libvirt'] }

- name: Display reset summary
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Show reset completion
      debug:
        msg:
          - "=========================================="
          - "OpenClaw Infrastructure Reset Complete"
          - "=========================================="
          - ""
          - "Removed:"
          - "  - All agent VMs and their services"
          - "  - OpenClaw configurations"
          - ""
          - "Preserved:"
          - "  - VM disk images in /var/lib/libvirt/images"
          - "  - Host configurations and packages"
          - "  - Libvirt and KVM packages (network cleaned up)"
          - "=========================================="
